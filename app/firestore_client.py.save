import os, json
from google.cloud.firestore_v1 import SERVER_TIMESTAMP

async def save_dialog(user_text: str,
                      bot_text: str,
                      *,
                      topic: str = "default"):
    await (_db.collection("dialogs")
              .document(topic)
              .collection("messages")
              .add({
                  "user": user_text,
                  "bot":  bot_text,
                  "time": SERVER_TIMESTAMP
              }))

async def get_last_dialog(topic: str, limit: int = 6):
    docs = (await _db.collection("dialogs")
                     .document(topic)
                     .collection("messages")
                     .order_by("time", direction="DESCENDING")
                     .limit(limit)
                     .get())
    return [d.to_dict() for d in docs][::-1]

